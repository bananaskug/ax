<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HARWELL PAY</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --background-color: #1a1a1a; --surface-color: #2c2c2c; --primary-color: #ffffff;
            --text-color: #e0e0e0; --text-secondary-color: #888888; --border-color: #444444;
            --font-main: 'Space Grotesk', sans-serif;
        }
        * { box-sizing: border-box; }
        body {
            font-family: var(--font-main); background-color: var(--background-color); color: var(--text-color);
            display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 1rem;
        }
        .app-container {
            width: 100%; max-width: 400px; background: var(--surface-color); border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2); overflow: hidden; border: 1px solid var(--border-color);
        }
        .screen { padding: 2.5rem 2rem; }
        h1, h2 { text-align: center; color: var(--primary-color); font-weight: 700; margin: 0; }
        h1 { margin-bottom: 0.5rem; font-size: 2rem; }
        h2 { margin-bottom: 2rem; font-size: 1.2rem; color: var(--text-secondary-color); font-weight: 400; }
        .form-group { margin-bottom: 1.5rem; }
        label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary-color); font-size: 0.9rem; }
        input, select {
            width: 100%; padding: 0.9rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem;
            background-color: var(--background-color); color: var(--text-color); font-family: var(--font-main);
        }
        select {
           -webkit-appearance: none; -moz-appearance: none; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23888' viewBox='0 0 16 16'%3E%3Cpath fill-rule='evenodd' d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 1rem center;
        }
        button {
            width: 100%; padding: 0.9rem; border: none; border-radius: 8px; background-color: var(--primary-color); color: #000000;
            font-size: 1.1rem; font-weight: 700; cursor: pointer; transition: transform 0.2s, background-color 0.2s; font-family: var(--font-main);
        }
        button:hover { transform: scale(1.02); }
        button:disabled { background-color: #555; color: #999; cursor: not-allowed; transform: scale(1); }
        #app-screen { display: none; }
        #balance-display { text-align: center; margin-bottom: 2.5rem; }
        #balance { font-size: 3.5rem; font-weight: 700; color: var(--primary-color); }
        .status { text-align: center; margin-top: 1rem; font-weight: 500; min-height: 20px; }
        .text-button-group { margin-top: 1.25rem; display: flex; flex-direction: column; align-items: center; gap: 0.75rem; } /* ADJUSTED MARGIN AND GAP */
        .text-button {
            background: none; border: none; padding: 0; color: var(--text-secondary-color);
            font-size: 0.9rem; font-weight: 500; cursor: pointer;
        }
        .text-button:hover { text-decoration: underline; }

        /* MODAL STYLES */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); }
        .modal-content { background-color: var(--surface-color); margin: 30% auto; padding: 2rem; border: 1px solid var(--border-color); border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
        .modal-close { color: var(--text-secondary-color); float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 0.5; }
        .modal-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; }
        #transactions-list { list-style: none; padding: 0; text-align: left; max-height: 300px; overflow-y: auto; }
        #transactions-list li { padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        #transactions-list li:last-child { border-bottom: none; }
        #transactions-list small { color: var(--text-secondary-color); display: block; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- ===== LOGIN SCREEN ===== -->
        <div id="login-screen" class="screen">
            <h1>HARWELL PAY</h1>
            <div class="form-group">
                <label for="user-select">Your Name</label>
                <select id="user-select" required></select>
            </div>
            <div class="form-group">
                <label for="pin-input">PIN</label>
                <input type="password" id="pin-input" inputmode="numeric" pattern="[0-9]*" required>
            </div>
            <button type="button" id="login-button">Login</button>
            <div id="login-status" class="status"></div>
        </div>

        <!-- ===== MAIN APP SCREEN ===== -->
        <div id="app-screen" class="screen">
            <h2 id="welcome-message">Welcome!</h2>
            <div id="balance-display">
                <label>Your Current Balance</label>
                <div id="balance">&0.00</div>
            </div>
            <form id="payment-form">
                <div class="form-group">
                    <label for="receiver-select">Send To</label>
                    <select id="receiver-select" required></select>
                </div>
                <div class="form-group">
                    <label for="amount-input">Amount (&)</label>
                    <input type="number" id="amount-input" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <button type="submit" id="send-button">Send</button>
                <div id="payment-status" class="status"></div>
            </form>
            <div class="text-button-group">
                <button type="button" id="transactions-button" class="text-button">Transactions</button>
                <button type="button" id="logout-button" class="text-button">Log Out</button>
            </div>
        </div>
    </div>
    
    <!-- MODALS -->
    <div id="transactions-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="close-transactions-modal">&times;</span>
            <div class="modal-title">Transaction History</div>
            <ul id="transactions-list"></ul>
        </div>
    </div>


    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzf6-kLkmzf57M1BJLasagt_ZDFK8KBNGQIseTrqiDwGXshMBfMrNccFxcCKl4xOgjDrQ/exec';
        const accounts = { 'Taj': { pin: '1595' }, 'Indi': { pin: '5421' }, 'Carly': { pin: '5421' }, 'Guahh': { pin: '1595' } };

        const loginScreen = document.getElementById('login-screen'), appScreen = document.getElementById('app-screen');
        const loginButton = document.getElementById('login-button'), logoutButton = document.getElementById('logout-button');
        const transactionsButton = document.getElementById('transactions-button');
        const paymentForm = document.getElementById('payment-form'), balanceDiv = document.getElementById('balance');
        const welcomeMessage = document.getElementById('welcome-message'), loginStatus = document.getElementById('login-status');
        const paymentStatus = document.getElementById('payment-status'), sendButton = document.getElementById('send-button');
        const userSelect = document.getElementById('user-select'), receiverSelect = document.getElementById('receiver-select');
        
        // Modal elements
        const transactionsModal = document.getElementById('transactions-modal');
        const closeModalButtons = document.querySelectorAll('.modal-close');

        let currentUser = null, userBalances = {}, allTransactions = [];

        function populateLoginDropdown() {
            userSelect.innerHTML = '<option value="" disabled selected>Select your name...</option>';
            for (const name in accounts) { userSelect.innerHTML += `<option value="${name}">${name}</option>`; }
        }

        function populateReceiverDropdown(loggedInUser) {
            receiverSelect.innerHTML = '<option value="">Select receiver...</option>';
            for (const name in accounts) { if (name !== loggedInUser) receiverSelect.innerHTML += `<option value="${name}">${name}</option>`; }
        }

        function calculateBalances(transactions) {
            const balances = {};
            Object.keys(accounts).forEach(user => balances[user] = 0);
            for (const tx of transactions) {
                const [ts, sender, pin, amount, receiver] = tx;
                const numAmount = parseFloat(amount);
                if (!isNaN(numAmount)) {
                    if (receiver && balances.hasOwnProperty(receiver)) balances[receiver] += numAmount;
                    if (sender && sender !== 'SYSTEM' && balances.hasOwnProperty(sender)) balances[sender] -= numAmount;
                }
            }
            return balances;
        }

        async function refreshDataAndUI(statusElement, message) {
            statusElement.textContent = message;
            const response = await fetch(WEB_APP_URL);
            if (!response.ok) throw new Error(`Network Error (${response.statusText}).`);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            
            allTransactions = result.data; // Store for history
            userBalances = calculateBalances(allTransactions);
            balanceDiv.textContent = `&${(userBalances[currentUser] || 0).toFixed(2)}`;
            statusElement.textContent = "";
        }
        
        async function performLogin(user) {
            currentUser = user;
            await refreshDataAndUI(loginStatus, "Logging In...");
            welcomeMessage.textContent = `Hello, ${currentUser}`;
            populateReceiverDropdown(currentUser);
            localStorage.setItem('harwell_loggedInUser', user);
            loginScreen.style.display = 'none';
            appScreen.style.display = 'block';
        }
        
        function showTransactions() {
            const list = document.getElementById('transactions-list');
            list.innerHTML = ''; // Clear old list
            
            const userTransactions = allTransactions
                .filter(tx => tx[1] === currentUser || tx[4] === currentUser)
                .sort((a, b) => new Date(b[0]) - new Date(a[0])); // Sort descending

            if (userTransactions.length === 0) {
                list.innerHTML = '<li>No transactions found.</li>';
            } else {
                userTransactions.forEach(tx => {
                    const [ts, sender, pin, amount, receiver] = tx;
                    const date = new Date(ts).toLocaleString();
                    let description = '';
                    if (sender === currentUser) {
                        description = `You sent &${parseFloat(amount).toFixed(2)} to ${receiver}`;
                    } else if (receiver === currentUser) {
                        description = `${sender} sent you &${parseFloat(amount).toFixed(2)}`;
                    }
                    if (description) {
                        const li = document.createElement('li');
                        li.innerHTML = `${description}<small>${date}</small>`;
                        list.appendChild(li);
                    }
                });
            }
            transactionsModal.style.display = 'block';
        }

        // Event Listeners
        loginButton.addEventListener('click', async () => {
            const selectedUser = userSelect.value, enteredPin = document.getElementById('pin-input').value;
            if (!selectedUser) { loginStatus.textContent = "Please select your name."; loginStatus.style.color = '#ff6b6b'; return; }
            if (!accounts[selectedUser] || accounts[selectedUser].pin !== enteredPin) { loginStatus.textContent = "Invalid PIN."; loginStatus.style.color = '#ff6b6b'; return; }
            loginButton.disabled = true;
            loginStatus.style.color = 'var(--text-secondary-color)';
            try { await performLogin(selectedUser); } 
            catch (error) { loginStatus.textContent = `Login failed: ${error.message}`; loginStatus.style.color = '#ff6b6b'; } 
            finally { loginButton.disabled = false; }
        });
        
        logoutButton.addEventListener('click', () => {
            localStorage.removeItem('harwell_loggedInUser');
            currentUser = null;
            appScreen.style.display = 'none';
            loginScreen.style.display = 'block';
            document.getElementById('pin-input').value = '';
            userSelect.value = '';
            loginStatus.textContent = '';
        });

        transactionsButton.addEventListener('click', showTransactions);

        paymentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const receiver = receiverSelect.value, amount = parseFloat(document.getElementById('amount-input').value);
            const currentUserBalance = userBalances[currentUser] || 0;
            paymentStatus.style.color = '#ff6b6b';
            if (!receiver) { paymentStatus.textContent = "Please select a receiver."; return; }
            if (isNaN(amount) || amount <= 0) { paymentStatus.textContent = "Please enter a valid amount."; return; }
            if (amount > currentUserBalance) { paymentStatus.textContent = "Insufficient funds!"; return; }
            sendButton.disabled = true;
            paymentStatus.style.color = 'var(--text-secondary-color)';
            const transactionData = { name: currentUser, pin: accounts[currentUser].pin, amount: amount, receiver: receiver };
            try {
                const response = await fetch(WEB_APP_URL, { method: 'POST', mode: 'cors', cache: 'no-cache', body: JSON.stringify(transactionData) });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                paymentStatus.textContent = "Success!";
                paymentStatus.style.color = '#45d966'; // Success Green
                paymentForm.reset();
                await refreshDataAndUI(paymentStatus, "Processing...");
            } catch (error) { paymentStatus.textContent = `Error: ${error.message}`; paymentStatus.style.color = '#ff6b6b'; } 
            finally { sendButton.disabled = false; }
        });

        closeModalButtons.forEach(btn => btn.onclick = () => { transactionsModal.style.display = 'none'; });
        window.onclick = (event) => { if (event.target == transactionsModal) { event.target.style.display = 'none'; } };

        document.addEventListener('DOMContentLoaded', async () => {
            populateLoginDropdown();
            const savedUser = localStorage.getItem('harwell_loggedInUser');
            if (savedUser && accounts[savedUser]) {
                loginButton.disabled = true; userSelect.value = savedUser; loginStatus.textContent = `Welcome back, ${savedUser}...`;
                try { await performLogin(savedUser); } 
                catch(error) { loginStatus.textContent = `Auto-login failed. Please log in manually.`; loginStatus.style.color = '#ff6b6b'; localStorage.removeItem('harwell_loggedInUser'); } 
                finally { loginButton.disabled = false; }
            }
        });
    </script>
</body>
</html>
